<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>í•˜ë£¨ ê³„íší‘œ</title>

    <!-- PWA manifest -->
    <link rel="manifest" href="./manifest.json">

    <meta name="theme-color" content="#3B82F6" />
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ì•½ê°„ ì •ë¦¬, ëª¨ë°”ì¼ ìš°ì„ ) */
        *{box-sizing:border-box;margin:0;padding:0}
        html,body{height:100%}
        body{
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
            background:linear-gradient(135deg,#EBF4FF 0%,#F3E8FF 100%);
            padding:16px;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }
        .container{max-width:720px;margin:0 auto}
        .header{
            background:rgba(255,255,255,0.95);
            padding:18px;border-radius:14px;backdrop-filter:blur(8px);
            margin-bottom:16px;border:1px solid rgba(0,0,0,0.04);
        }
        .title-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
        .title-text{font-size:20px;font-weight:700;color:#1F2937}
        .subtitle-text{color:#6B7280;margin-top:8px}
        .edit-inline{display:flex;gap:8px;margin-top:8px}
        .edit-inline input{flex:1;padding:8px;border-radius:8px;border:1px solid #D1D5DB}
        .btn{padding:8px 12px;border-radius:8px;border:none;background:#3B82F6;color:#fff;cursor:pointer;font-weight:600}
        .btn.ghost{background:transparent;color:#374151;border:1px solid rgba(0,0,0,0.06)}
        .progress-container{margin-top:12px;background:white;border-radius:12px;padding:8px}
        .progress-bar{height:12px;border-radius:12px;background:linear-gradient(90deg,#3B82F6,#8B5CF6);width:0%}
        .progress-text{font-size:13px;color:#6B7280;margin-top:8px}

        /* ì„¹ì…˜ */
        #sections-container{display:flex;flex-direction:column;gap:12px}
        .section{
            background:rgba(255,255,255,0.9);border-radius:12px;padding:12px;border:1px solid rgba(0,0,0,0.04);
            transition:box-shadow .12s;
        }
        .section.dragging{opacity:.6;box-shadow:0 6px 24px rgba(0,0,0,0.08)}
        .section-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
        .section-title{display:flex;align-items:center;gap:8px;font-weight:700;color:#1F2937}
        .section-controls{display:flex;align-items:center;gap:8px}
        .collapse-btn{background:none;border:none;padding:6px;border-radius:8px;cursor:pointer}
        .add-task{margin-top:10px;display:flex;flex-direction:column;gap:8px}
        .add-task input{padding:10px;border-radius:8px;border:1px solid #D1D5DB}
        .task-list{margin-top:8px;display:flex;flex-direction:column;gap:8px}
        .task-item{display:flex;gap:12px;align-items:flex-start;padding:10px;border-radius:10px}
        .task-item:hover{background:rgba(255,255,255,0.6)}
        .checkbox{width:20px;height:20px;border-radius:6px;border:2px solid #D1D5DB;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
        .checkbox.checked{background:#10B981;border-color:#10B981;color:white}
        .task-content{flex:1}
        .task-text{font-size:14px;color:#374151;margin-bottom:6px}
        .task-time{font-size:12px;color:#6B7280}
        .task-text.completed{text-decoration:line-through;color:#9CA3AF}
        .more-btn{background:none;border:0;padding:6px;border-radius:6px;cursor:pointer}
        .more-menu{position:fixed;background:white;border-radius:8px;padding:6px;border:1px solid rgba(0,0,0,0.08);box-shadow:0 8px 24px rgba(0,0,0,0.08);z-index:1000}
        .more-menu button{display:block;padding:8px 12px;background:transparent;border:none;text-align:left;width:100%;cursor:pointer}
        .reflection{background:rgba(255,255,255,0.95);border-radius:12px;padding:12px;margin-top:12px}
        .reflection textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #D1D5DB;resize:vertical}

        /* ìƒ‰ìƒ ë°” */
        .spiritual{border-left:4px solid #3B82F6}
        .gospel{border-left:4px solid #EF4444}
        .creative{border-left:4px solid #F59E0B}
        .community{border-left:4px solid #10B981}
        .selfcare{border-left:4px solid #8B5CF6}

        /* ë°˜ì‘í˜• */
        @media(min-width:760px){
            .title-text{font-size:24px}
            .subtitle-text{font-size:15px}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" id="headerBox">
            <div class="title-row">
                <div>
                    <div style="display:flex;align-items:center;gap:8px">
                        <div class="title-text" id="appTitleDisplay">ë³µìŒ ì¤‘ì‹¬ í•˜ë£¨ ê³„íš</div>
                        <button class="btn ghost" id="editHeaderBtn" title="ë°°ë„ˆ í¸ì§‘">í¸ì§‘</button>
                    </div>
                    <div class="subtitle-text" id="appSubtitleDisplay">í•˜ëŠë‹˜ì˜ ëœ» ì•ˆì—ì„œ ì°½ì¡°ì ì´ê³  ì˜ë¯¸ ìˆëŠ” í•˜ë£¨ë¥¼</div>
                </div>
                <div style="text-align:right">
                    <div class="progress-container">
                        <div style="background:#F3F4F6;border-radius:12px;padding:4px">
                            <div class="progress-bar" id="progressBar" style="width:0%"></div>
                        </div>
                        <div class="progress-text" id="progressText">ì™„ë£Œ: 0 / 0 (0%)</div>
                    </div>
                </div>
            </div>

            <!-- inline edit area -->
            <div class="edit-inline" id="headerEditArea" style="display:none;margin-top:12px">
                <input id="appTitleInput" placeholder="ì•± ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
                <input id="appSubtitleInput" placeholder="ë¶€ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
                <button class="btn" id="saveHeaderBtn">ì €ì¥</button>
                <button class="btn ghost" id="cancelHeaderBtn">ì·¨ì†Œ</button>
            </div>
        </div>

        <div id="sections-container"></div>

        <div class="reflection" id="reflectionBox">
            <div style="display:flex;align-items:center;justify-content:space-between">
                <div style="font-weight:700">ğŸ“– ì˜¤ëŠ˜ì˜ ì„±ì°°</div>
                <div style="display:flex;gap:8px;align-items:center">
                    <button class="collapse-btn" id="toggleReflectionBtn" title="ì ‘ê¸°/í¼ì¹˜ê¸°">â–¾</button>
                </div>
            </div>
            <div id="reflectionContent" style="margin-top:10px">
                <div style="margin-bottom:10px">
                    <div style="font-weight:500;margin-bottom:6px">í•˜ëŠë‹˜ì˜ ì‚¬ë‘ì„ ì–´ë–»ê²Œ ê²½í—˜í–ˆë‚˜ìš”?</div>
                    <textarea rows="2" id="reflection1" placeholder="ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”..."></textarea>
                </div>
                <div style="margin-bottom:10px">
                    <div style="font-weight:500;margin-bottom:6px">ì˜¤ëŠ˜ ê°€ì¥ ì°½ì¡°ì ì´ì—ˆë˜ ìˆœê°„ì€?</div>
                    <textarea rows="2" id="reflection2" placeholder="ì‘ì€ ìˆœê°„ë“¤ë„ ì†Œì¤‘í•´ìš”..."></textarea>
                </div>
                <div>
                    <div style="font-weight:500;margin-bottom:6px">ë‚´ì¼ ë” ë‚˜ì€ í•˜ë£¨ë¥¼ ìœ„í•œ ë‹¤ì§</div>
                    <textarea rows="2" id="reflection3" placeholder="í•˜ëŠë‹˜ê³¼ í•¨ê»˜í•˜ëŠ” ë‚´ì¼ì„..."></textarea>
                </div>
            </div>
        </div>

        <div style="text-align:center;margin-top:14px;color:#6B7280;font-size:12px">
            "ê·¸ëŸ¬ë¯€ë¡œ ì˜¤ëŠ˜ í•  ì¼ì„ ë‚´ì¼ë¡œ ë¯¸ë£¨ì§€ ë§ë¼. ì£¼ë‹˜ ì•ˆì—ì„œ í•˜ë£¨í•˜ë£¨ë¥¼ ì¶©ì‹¤íˆ ì‚´ì•„ê°€ë¼." ğŸ’•
        </div>
    </div>

    <!-- ë”ë³´ê¸° ë©”ë‰´(ì „ì—­) -->
    <div id="moreMenu" class="more-menu" style="display:none"></div>

    <script>
        /* ----------------------------
           ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í‚¤ ì •ì˜
           ---------------------------- */
        const KEY_SECTIONS = 'planner_sections_v1';
        const KEY_META = 'planner_meta_v1'; // ì œëª©, ë¶€ì œ
        const KEY_REFLECTIONS = 'planner_reflections_v1';
        const KEY_COLLAPSED = 'planner_collapsed_v1';

        /* ----------------------------
           ê¸°ë³¸ ì„¹ì…˜ ë°ì´í„°
           ---------------------------- */
        const DEFAULT_SECTIONS = [
            {
                id: 'spiritual',
                title: 'ğŸ“– ì˜ì  ê¸°ì´ˆ ë‹¤ì§€ê¸°',
                class: 'spiritual',
                items: [
                    { id: 'morning_prayer', text: 'ìƒˆë²½ ê¸°ë„/ë¬µìƒ ì‹œê°„ (30ë¶„)', time: '06:00-06:30', checked:false },
                    { id: 'scripture', text: 'ì„±ê²½ ì½ê¸° ë° ë¬µìƒ', time: '06:30-07:00', checked:false },
                    { id: 'gratitude', text: 'ê°ì‚¬ ì¼ê¸° 3ê°€ì§€ ì ê¸°', time: 'ì €ë…', checked:false }
                ]
            },
            {
                id: 'gospel',
                title: 'â¤ï¸ ë³µìŒì„ ì‚¶ìœ¼ë¡œ ì„ í¬í•˜ê¸°',
                class: 'gospel',
                items: [
                    { id: 'kindness', text: 'ì£¼ë³€ ì‚¬ëŒì—ê²Œ ì¹œì ˆí•œ í–‰ë™ í•˜ë‚˜ ì‹¤ì²œí•˜ê¸°', time: 'ìˆ˜ì‹œ', checked:false },
                    { id: 'listening', text: 'ëˆ„êµ°ê°€ì˜ ì´ì•¼ê¸° ì§„ì‹¬ìœ¼ë¡œ ë“£ê¸°', time: 'ìˆ˜ì‹œ', checked:false },
                    { id: 'encouragement', text: 'ê²©ë ¤ë‚˜ ìœ„ë¡œì˜ ë§ ê±´ë„¤ê¸°', time: 'ìˆ˜ì‹œ', checked:false },
                    { id: 'service', text: 'ì‘ì€ ë´‰ì‚¬ë‚˜ ë„ì›€ ì œê³µí•˜ê¸°', time: 'ì˜¤í›„', checked:false }
                ]
            },
            {
                id: 'creative',
                title: 'ğŸ’¡ ì°½ì¡°ì  í•˜ë£¨ ì‚´ê¸°',
                class: 'creative',
                items: [
                    { id: 'creative_time', text: 'ì°½ì¡°ì  í™œë™ ì‹œê°„ (ê¸€ì“°ê¸°/ê·¸ë¦¼/ìŒì•…/ê³µì˜ˆ ë“±)', time: '09:00-11:00', checked:false },
                    { id: 'learning', text: 'ìƒˆë¡œìš´ ê²ƒ ë°°ìš°ê¸° ë˜ëŠ” ê¸°ìˆ  í–¥ìƒ', time: '14:00-15:30', checked:false },
                    { id: 'reflection', text: 'ì˜¤ëŠ˜ì˜ ì°½ì¡°ì  ìˆœê°„ë“¤ ê¸°ë¡í•˜ê¸°', time: 'ì €ë…', checked:false },
                    { id: 'innovation', text: 'ì¼ìƒì˜ ì‘ì€ ê²ƒ í•˜ë‚˜ ê°œì„ í•´ë³´ê¸°', time: 'ìˆ˜ì‹œ', checked:false }
                ]
            },
            {
                id: 'community',
                title: 'ğŸ‘¥ ê³µë™ì²´ì™€ ì—°ê²°',
                class: 'community',
                items: [
                    { id: 'family_time', text: 'ê°€ì¡±ê³¼ ì˜ë¯¸ ìˆëŠ” ì‹œê°„ ë³´ë‚´ê¸°', time: 'ì €ë…', checked:false },
                    { id: 'community', text: 'ì‹ ì•™ ê³µë™ì²´ë‚˜ ëª¨ì„ ì°¸ì—¬/ì—°ë½', time: 'ì˜¤í›„', checked:false },
                    { id: 'neighbor', text: 'ì´ì›ƒì´ë‚˜ ì§€ì—­ì‚¬íšŒ ê´€ì‹¬ ê°–ê¸°', time: 'ìˆ˜ì‹œ', checked:false }
                ]
            },
            {
                id: 'selfcare',
                title: 'â˜• ëª¸ê³¼ ë§ˆìŒ ëŒë³´ê¸°',
                class: 'selfcare',
                items: [
                    { id: 'exercise', text: 'ëª¸ì„ ì›€ì§ì´ëŠ” ì‹œê°„ (ì‚°ì±…/ìš´ë™)', time: '08:00-09:00', checked:false },
                    { id: 'healthy_meal', text: 'ì •ì„±ìŠ¤ëŸ½ê²Œ ì‹ì‚¬ ì¤€ë¹„í•˜ê³  ê°ì‚¬íˆ ë¨¹ê¸°', time: 'ì‹ì‚¬ì‹œê°„', checked:false },
                    { id: 'rest', text: 'ì¶©ë¶„í•œ íœ´ì‹ê³¼ ì—¬ìœ  ì‹œê°„', time: '20:00-21:00', checked:false },
                    { id: 'evening_prayer', text: 'í•˜ë£¨ë¥¼ ë§ˆë¬´ë¦¬í•˜ëŠ” ê¸°ë„', time: '21:30', checked:false }
                ]
            }
        ];

        /* ----------------------------
           ìƒíƒœ ë³€ìˆ˜
           ---------------------------- */
        let sections = []; // ì‹¤ì œ ì‚¬ìš©ë˜ëŠ” ì„¹ì…˜ ë°°ì—´
        let meta = { title: 'ë³µìŒ ì¤‘ì‹¬ í•˜ë£¨ ê³„íš', subtitle: 'í•˜ëŠë‹˜ì˜ ëœ» ì•ˆì—ì„œ ì°½ì¡°ì ì´ê³  ì˜ë¯¸ ìˆëŠ” í•˜ë£¨ë¥¼' };
        let reflections = { r1: '', r2: '', r3: '' };
        let collapsedState = { /* sectionId: true/false, reflection: true/false */ };

        /* ----------------------------
           ìœ í‹¸: ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë¡œë“œ/ì €ì¥
           ---------------------------- */
        function loadAll(){
            const saved = localStorage.getItem(KEY_SECTIONS);
            if (saved) {
                try {
                    sections = JSON.parse(saved);
                } catch(e){
                    sections = JSON.parse(JSON.stringify(DEFAULT_SECTIONS));
                }
            } else {
                sections = JSON.parse(JSON.stringify(DEFAULT_SECTIONS));
            }

            const metaRaw = localStorage.getItem(KEY_META);
            if (metaRaw) {
                try { meta = JSON.parse(metaRaw); } catch(e){}
            }

            const refRaw = localStorage.getItem(KEY_REFLECTIONS);
            if (refRaw) {
                try { reflections = JSON.parse(refRaw); } catch(e){}
            }

            const colRaw = localStorage.getItem(KEY_COLLAPSED);
            if (colRaw) {
                try { collapsedState = JSON.parse(colRaw); } catch(e){}
            } else {
                // ê¸°ë³¸ê°’: í¼ì³ì§
                collapsedState = { reflection: false };
                sections.forEach(s => collapsedState[s.id] = false);
            }
        }

        function saveAll(){
            localStorage.setItem(KEY_SECTIONS, JSON.stringify(sections));
            localStorage.setItem(KEY_META, JSON.stringify(meta));
            localStorage.setItem(KEY_REFLECTIONS, JSON.stringify(reflections));
            localStorage.setItem(KEY_COLLAPSED, JSON.stringify(collapsedState));
        }

        /* ----------------------------
           ë‚ ì§œ/ì§„í–‰ë„ ì—…ë°ì´íŠ¸
           ---------------------------- */
        function updateDateAndProgress(){
            // ë‚ ì§œ í…ìŠ¤íŠ¸ (í—¤ë” ì•„ë˜ì— í‘œì‹œë˜ì–´ ìˆì—ˆìœ¼ë‚˜ ì‚­ì œ â€” í•„ìš”í•˜ë©´ ë‹¤ì‹œ ì¶”ê°€í•˜ì„¸ìš”)
            const total = sections.reduce((sum,s)=>sum + s.items.length,0);
            const done = sections.reduce((sum,s)=>sum + s.items.filter(i=>i.checked).length,0);
            const pct = total? Math.round((done/total)*100) : 0;
            document.getElementById('progressBar').style.width = pct + '%';
            document.getElementById('progressText').textContent = `ì™„ë£Œ: ${done} / ${total} (${pct}%)`;
        }

        /* ----------------------------
           ë Œë”ë§
           ---------------------------- */
        function renderSections(){
            const container = document.getElementById('sections-container');
            container.innerHTML = '';

            sections.forEach(section => {
                const sec = document.createElement('div');
                sec.className = 'section ' + section.class;
                sec.dataset.id = section.id;
                sec.draggable = true;

                // header
                const header = document.createElement('div');
                header.className = 'section-header';

                const titleDiv = document.createElement('div');
                titleDiv.className = 'section-title';
                titleDiv.innerHTML = `<span>${section.title}</span>`;

                const controls = document.createElement('div');
                controls.className = 'section-controls';

                // drag handle (for UX only)
                const dragHandle = document.createElement('button');
                dragHandle.className = 'collapse-btn';
                dragHandle.title = 'ì„¹ì…˜ ë“œë˜ê·¸ë¡œ ì´ë™';
                dragHandle.textContent = 'â‰¡';
                dragHandle.style.fontWeight = '700';

                // collapse toggle
                const collapseBtn = document.createElement('button');
                collapseBtn.className = 'collapse-btn';
                collapseBtn.textContent = collapsedState[section.id] ? 'â–¸' : 'â–¾';
                collapseBtn.title = 'ì ‘ê¸°/í¼ì¹˜ê¸°';
                collapseBtn.onclick = (e) => {
                    e.stopPropagation();
                    collapsedState[section.id] = !collapsedState[section.id];
                    saveAll();
                    renderSections();
                };

                // add controls
                controls.appendChild(dragHandle);
                controls.appendChild(collapseBtn);

                header.appendChild(titleDiv);
                header.appendChild(controls);
                sec.appendChild(header);

                // content (tasks)
                const content = document.createElement('div');
                content.style.marginTop = '10px';
                content.style.display = collapsedState[section.id] ? 'none' : 'block';

                // task list
                const taskList = document.createElement('div');
                taskList.className = 'task-list';

                // sort: ì™„ë£Œëœ í•­ëª©ì„ ì•„ë˜ë¡œ
                const itemsSorted = [...section.items].sort((a,b)=> (a.checked === b.checked) ? 0 : (a.checked ? 1 : -1));

                itemsSorted.forEach(item => {
                    const task = document.createElement('div');
                    task.className = 'task-item';

                    // checkbox
                    const chk = document.createElement('div');
                    chk.className = 'checkbox' + (item.checked ? ' checked' : '');
                    chk.innerHTML = item.checked ? 'âœ“' : '';
                    chk.onclick = (ev) => {
                        ev.stopPropagation();
                        item.checked = !item.checked;
                        saveAll();
                        updateDateAndProgress();
                        renderSections();
                    };

                    // content
                    const cont = document.createElement('div');
                    cont.className = 'task-content';

                    const textDiv = document.createElement('div');
                    textDiv.className = 'task-text' + (item.checked ? ' completed' : '');
                    textDiv.textContent = item.text;

                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'task-time';
                    timeDiv.textContent = item.time || '';

                    cont.appendChild(textDiv);
                    cont.appendChild(timeDiv);

                    // three-dot menu
                    const moreBtn = document.createElement('button');
                    moreBtn.className = 'more-btn';
                    moreBtn.innerHTML = 'â‹¯';
                    moreBtn.onclick = (ev) => {
                        ev.stopPropagation();
                        openMoreMenu(ev.clientX, ev.clientY, section.id, item.id);
                    };

                    // assemble
                    task.appendChild(chk);
                    task.appendChild(cont);
                    task.appendChild(moreBtn);

                    taskList.appendChild(task);
                });

                content.appendChild(taskList);

                // add-task area (ë³´ì´ë„ë¡ í¸ì§‘ ëª¨ë“œì—ì„œë§Œ)
                const addWrap = document.createElement('div');
                addWrap.className = 'add-task';

                const tInput = document.createElement('input');
                tInput.placeholder = 'ìƒˆë¡œìš´ í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”';

                const timeInput = document.createElement('input');
                timeInput.placeholder = 'ì‹œê°„ (ì˜ˆ: 09:00-10:00)';

                const addBtn = document.createElement('button');
                addBtn.className = 'btn';
                addBtn.textContent = 'â• ì¶”ê°€í•˜ê¸°';
                addBtn.onclick = () => {
                    const text = tInput.value.trim();
                    if (!text) return;
                    const newTask = { id: 'custom_' + Date.now(), text, time: timeInput.value.trim() || 'ìˆ˜ì‹œ', checked:false };
                    section.items.push(newTask);
                    tInput.value = '';
                    timeInput.value = '';
                    saveAll();
                    updateDateAndProgress();
                    renderSections();
                };

                addWrap.appendChild(tInput);
                addWrap.appendChild(timeInput);
                addWrap.appendChild(addBtn);

                content.appendChild(addWrap);

                sec.appendChild(content);

                // drag events
                sec.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', section.id);
                    sec.classList.add('dragging');
                });
                sec.addEventListener('dragend', (e) => {
                    sec.classList.remove('dragging');
                });

                // allow drop on sections container
                sec.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                sec.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const draggedId = e.dataTransfer.getData('text/plain');
                    const targetId = section.id;
                    if (draggedId && draggedId !== targetId){
                        reorderSections(draggedId, targetId);
                        saveAll();
                        renderSections();
                    }
                });

                container.appendChild(sec);
            });

            updateDateAndProgress();
        }

        /* ----------------------------
           ë”ë³´ê¸° ë©”ë‰´(ì „ì—­) - Edit / Delete ë™ì‘
           ---------------------------- */
        const moreMenu = document.getElementById('moreMenu');
        function openMoreMenu(x,y, sectionId, itemId){
            moreMenu.style.left = (x+6) + 'px';
            moreMenu.style.top = (y+6) + 'px';
            moreMenu.style.display = 'block';
            moreMenu.innerHTML = '';

            const btnEdit = document.createElement('button');
            btnEdit.textContent = 'í¸ì§‘';
            btnEdit.onclick = (e) => {
                e.stopPropagation();
                moreMenu.style.display = 'none';
                startEditItem(sectionId, itemId);
            };
            const btnDelete = document.createElement('button');
            btnDelete.textContent = 'ì‚­ì œ';
            btnDelete.onclick = (e) => {
                e.stopPropagation();
                moreMenu.style.display = 'none';
                if (confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ì–´ìš”?')) {
                    deleteItem(sectionId, itemId);
                }
            };

            moreMenu.appendChild(btnEdit);
            moreMenu.appendChild(btnDelete);
        }

        document.addEventListener('click', (e)=>{
            // ë”ë³´ê¸° ë©”ë‰´ ë‹«ê¸°
            if (moreMenu.style.display === 'block'){
                moreMenu.style.display = 'none';
            }
        });

        function findSectionById(id){
            return sections.find(s => s.id === id);
        }

        function findItem(sectionId, itemId){
            const s = findSectionById(sectionId);
            if (!s) return null;
            return s.items.find(i => i.id === itemId);
        }

        function deleteItem(sectionId, itemId){
            const s = findSectionById(sectionId);
            if (!s) return;
            s.items = s.items.filter(i => i.id !== itemId);
            saveAll();
            renderSections();
        }

        function startEditItem(sectionId, itemId){
            // inline í¸ì§‘: í•´ë‹¹ í•­ëª©ì˜ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥ì°½ìœ¼ë¡œ ë°”ê¿”ì„œ ì €ì¥
            const s = findSectionById(sectionId);
            if (!s) return;
            const item = s.items.find(i => i.id === itemId);
            if (!item) return;

            // ë Œë”ë§ì„ ë‹¤ì‹œ í•˜ì—¬ DOM ì°¸ì¡°ë¥¼ ì–»ìŒ
            renderSections();

            // find the task element in DOM
            const container = document.getElementById('sections-container');
            const secEl = Array.from(container.children).find(ch => ch.dataset.id === sectionId);
            if (!secEl) return;
            const taskItems = secEl.querySelectorAll('.task-item');
            let targetEl = null;
            for (const t of taskItems){
                const txt = t.querySelector('.task-text');
                if (txt && txt.textContent === item.text) { targetEl = t; break; }
            }
            if (!targetEl) return;

            const contentDiv = targetEl.querySelector('.task-content');
            contentDiv.innerHTML = `
                <input class="edit-text" style="width:100%;padding:8px;border-radius:8px;border:1px solid #D1D5DB" value="${escapeHtml(item.text)}" />
                <input class="edit-time" style="margin-top:6px;padding:8px;border-radius:8px;border:1px solid #D1D5DB" value="${escapeHtml(item.time||'')}" />
                <div style="margin-top:6px;display:flex;gap:8px">
                    <button class="btn save-edit">ì €ì¥</button>
                    <button class="btn ghost cancel-edit">ì·¨ì†Œ</button>
                </div>
            `;

            const saveBtn = contentDiv.querySelector('.save-edit');
            const cancelBtn = contentDiv.querySelector('.cancel-edit');
            const txtInput = contentDiv.querySelector('.edit-text');
            const timeInput = contentDiv.querySelector('.edit-time');

            saveBtn.onclick = (ev)=>{
                ev.stopPropagation();
                const newText = txtInput.value.trim();
                const newTime = timeInput.value.trim() || 'ìˆ˜ì‹œ';
                if (!newText) { alert('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
                item.text = newText;
                item.time = newTime;
                saveAll();
                renderSections();
            };
            cancelBtn.onclick = (ev)=>{
                ev.stopPropagation();
                renderSections();
            };
        }

        function escapeHtml(s){
            return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
        }

        /* ----------------------------
           ì„¹ì…˜ ì¬ë°°ì—´ í•¨ìˆ˜
           ---------------------------- */
        function reorderSections(draggedId, targetId){
            const fromIdx = sections.findIndex(s => s.id === draggedId);
            const toIdx = sections.findIndex(s => s.id === targetId);
            if (fromIdx === -1 || toIdx === -1) return;
            const [item] = sections.splice(fromIdx,1);
            sections.splice(toIdx,0,item);
        }

        /* ----------------------------
           í—¤ë” í¸ì§‘
           ---------------------------- */
        const editHeaderBtn = document.getElementById('editHeaderBtn');
        const headerEditArea = document.getElementById('headerEditArea');
        const appTitleDisplay = document.getElementById('appTitleDisplay');
        const appSubtitleDisplay = document.getElementById('appSubtitleDisplay');
        const appTitleInput = document.getElementById('appTitleInput');
        const appSubtitleInput = document.getElementById('appSubtitleInput');
        const saveHeaderBtn = document.getElementById('saveHeaderBtn');
        const cancelHeaderBtn = document.getElementById('cancelHeaderBtn');

        editHeaderBtn.onclick = () => {
            headerEditArea.style.display = 'flex';
            appTitleInput.value = meta.title || '';
            appSubtitleInput.value = meta.subtitle || '';
            appTitleInput.focus();
        };
        cancelHeaderBtn.onclick = () => {
            headerEditArea.style.display = 'none';
        };
        saveHeaderBtn.onclick = () => {
            meta.title = appTitleInput.value.trim() || 'í•˜ë£¨ ê³„íší‘œ';
            meta.subtitle = appSubtitleInput.value.trim() || '';
            headerEditArea.style.display = 'none';
            updateHeaderTexts();
            saveAll();
        };
        function updateHeaderTexts(){
            appTitleDisplay.textContent = meta.title || '';
            appSubtitleDisplay.textContent = meta.subtitle || '';
        }

        /* ----------------------------
           Reflection ì ‘ê¸°/í¼ì¹˜ê¸° & ì €ì¥
           ---------------------------- */
        const toggleReflectionBtn = document.getElementById('toggleReflectionBtn');
        const reflectionContent = document.getElementById('reflectionContent');
        function updateReflectionBox(){
            const collapsed = !!collapsedState.reflection;
            reflectionContent.style.display = collapsed ? 'none' : 'block';
            toggleReflectionBtn.textContent = collapsed ? 'â–¸' : 'â–¾';
        }
        toggleReflectionBtn.onclick = () => {
            collapsedState.reflection = !collapsedState.reflection;
            updateReflectionBox();
            saveAll();
        };
        // reflection textarea ì €ì¥
        ['reflection1','reflection2','reflection3'].forEach(id=>{
            const el = document.getElementById(id);
            el.addEventListener('input', (e) => {
                reflections.r1 = document.getElementById('reflection1').value;
                reflections.r2 = document.getElementById('reflection2').value;
                reflections.r3 = document.getElementById('reflection3').value;
                saveAll();
            });
        });

        /* ----------------------------
           ì´ˆê¸°í™”
           ---------------------------- */
        function init(){
            loadAll();
            updateHeaderTexts();
            // ë°˜ì˜: reflection textarea ê°’ ì±„ìš°ê¸°
            document.getElementById('reflection1').value = reflections.r1 || '';
            document.getElementById('reflection2').value = reflections.r2 || '';
            document.getElementById('reflection3').value = reflections.r3 || '';

            // ensure collapsedState has keys for all sections
            sections.forEach(s => { if (collapsedState[s.id] === undefined) collapsedState[s.id] = false; });

            updateReflectionBox();
            renderSections();
            updateDateAndProgress();

            // PWA: install prompt handling (ë¸Œë¼ìš°ì €ê°€ ì œê³µí•˜ë©´ ëœ¸)
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                // í•„ìš”í•˜ë©´ ì´ ì´ë²¤íŠ¸ë¥¼ ì €ì¥í•´ì„œ ë³„ë„ ì„¤ì¹˜ UIë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                console.log('beforeinstallprompt captured', e);
            });

            // ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').then(reg=>{
                    console.log('ServiceWorker ë“±ë¡ë¨', reg.scope);
                }).catch(err=>{
                    console.warn('ServiceWorker ë“±ë¡ ì‹¤íŒ¨', err);
                });
            }
        }

        // ì‹œì‘
        init();
    </script>
</body>
</html>
